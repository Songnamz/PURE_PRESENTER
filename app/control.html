<!DOCTYPE html>
<html>
  <head>
    <style>
      /* Custom Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #1a1a2e;
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #7a8ef5 0%, #8659b3 100%);
      }

      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        margin: 0;
      }

      .btn {
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 500;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
      }

      .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #757f9a 0%, #d7dde8 100%);
        color: #333;
      }

      .btn-hide {
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        color: white;
      }

      .btn-group {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .shortcut {
        opacity: 0.8;
        font-size: 13px;
        font-weight: normal;
      }

      .select-wrapper {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      select {
        padding: 10px 16px;
        font-size: 14px;
        background: #2a2a3e;
        color: white;
        border: 2px solid #444;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
      }

      select:hover {
        border-color: #667eea;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      }

      .slide-dot {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: #444;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        font-weight: 600;
        color: #888;
        border: 2px solid #555;
      }

      .slide-dot:hover {
        background: #555;
        border-color: #667eea;
        transform: scale(1.1);
      }

      .slide-dot.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #764ba2;
        transform: scale(1.15);
      }

      .slide-thumbnails {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
        max-height: 600px;
        overflow-y: auto;
        padding: 10px;
        background: rgba(0,0,0,0.3);
        border-radius: 8px;
      }

      .slide-thumbnail {
        background: #2a2a3e;
        border: 3px solid #444;
        border-radius: 8px;
        padding: 30px 15px 15px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }

      .slide-thumbnail:hover {
        border-color: #667eea;
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .slide-thumbnail.active {
        border-color: #764ba2;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
        box-shadow: 0 0 15px rgba(118, 75, 162, 0.5);
      }

      .slide-thumbnail-number {
        position: absolute;
        top: 5px;
        left: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }

      .slide-thumbnail-content {
        font-size: 11px;
        color: #ccc;
        text-align: center;
        width: 100%;
        line-height: 1.4;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .copyright-footer {
        position: fixed;
        bottom: 10px;
        right: 15px;
        font-size: 10px;
        color: #999;
        font-style: italic;
        z-index: 1000;
        pointer-events: none;
      }

      /* Visual Editor Modal */
      .editor-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        overflow: auto;
      }

      .editor-content {
        margin: 20px auto;
        max-width: 1400px;
        background: #1a1a2e;
        border-radius: 12px;
        padding: 20px;
      }

      .editor-canvas {
        width: 1000px;
        height: 600px;
        background: #000;
        border: 2px solid #667eea;
        border-radius: 8px;
        position: relative;
        margin: 20px auto;
        overflow: hidden;
        cursor: crosshair;
      }

      .text-element {
        position: absolute;
        color: white;
        cursor: text; /* allow text caret */
        padding: 10px;
        border: 2px dashed transparent;
        user-select: text; /* enable selecting/caret */
        text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        outline: none; /* hide default outline on focus */
      }

      .text-element:hover {
        border-color: #667eea;
        background: rgba(102, 126, 234, 0.1);
      }

      .text-element.selected {
        border-color: #a8e063;
        background: rgba(168, 224, 99, 0.1);
      }

      .editor-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .toolbar-group {
        display: flex;
        gap: 5px;
        align-items: center;
        background: #2a2a3e;
        padding: 8px;
        border-radius: 6px;
      }

      .toolbar-label {
        color: #aaa;
        font-size: 12px;
        margin-right: 5px;
      }

      .toolbar-input {
        padding: 5px 10px;
        background: #1a1a2e;
        color: white;
        border: 1px solid #444;
        border-radius: 4px;
        width: 80px;
      }

      .toolbar-btn {
        padding: 6px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .toolbar-btn:hover {
        background: linear-gradient(135deg, #7a8ef5 0%, #8659b3 100%);
      }
    </style>
  </head>
  <body>
    <h2 style="margin-top:0; font-size:28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Control & Preview</h2>
    <div id="song-title" style="font-size:18px; font-weight:bold; margin-bottom:16px; color:#a8e063;"></div>
    
    <div class="btn-group">
      <button onclick="prevSlide()" class="btn btn-primary">
        ‚¨Ö Previous <span class="shortcut"></span>
      </button>
      <button onclick="nextSlide()" class="btn btn-primary">
        Next ‚û° / Space<span class="shortcut"></span>
      </button>
      <button id="projector-toggle" onclick="toggleProjector()" class="btn btn-success">
        üì∫ Open Projector <span class="shortcut">Alt+X</span>
      </button>
      <button id="projector-hide" onclick="toggleHideProjector()" class="btn btn-hide" style="display:none;">
        üëÅÔ∏è Show Projector <span class="shortcut">Alt+U</span>
      </button>
    </div>

    <div class="btn-group">
      <button onclick="decreaseFontSize()" class="btn btn-warning" title="Arrow Down">
        üî§‚ûñ Decrease Font Size (‚Üì)
      </button>
      <button onclick="resetFontSize()" class="btn btn-info" title="Ctrl+0">
        üî§‚Üª Reset Font Size (Ctrl+0)
      </button>
      <button onclick="increaseFontSize()" class="btn btn-warning" title="Arrow Up">
        üî§‚ûï Increase Font Size (‚Üë)
      </button>
    </div>

    <div id="image-zoom-controls" class="btn-group" style="display:none;">
      <button onclick="zoomOutImage()" class="btn btn-warning" title="Zoom Out Image">
        üîç‚ûñ Zoom Out
      </button>
      <button onclick="resetImageZoom()" class="btn btn-info" title="Reset Image Zoom">
        üîç‚Üª Reset Zoom
      </button>
      <button onclick="zoomInImage()" class="btn btn-warning" title="Zoom In Image">
        üîç‚ûï Zoom In
      </button>
    </div>

    <div style="display:flex; gap:10px;">
      <div class="select-wrapper" style="flex:1;">
        <label style="font-size:15px; font-weight:500;">üé® Service Background:</label>
        <select id="service-background-select" onchange="changeServiceBackground()">
          <option value="">No Background</option>
        </select>
      </div>

      <div class="select-wrapper" style="flex:1;">
        <label style="font-size:15px; font-weight:500;">üé® Hymnal Background:</label>
        <select id="background-select" onchange="changeBackground()">
          <option value="">No Background</option>
        </select>
      </div>
    </div>

    <div class="select-wrapper">
      <label style="font-size:15px; font-weight:500;">üìñ Bible Verse Background:</label>
      <select id="bible-background-select" onchange="changeBibleBackground()">
        <option value="">No Background</option>
      </select>
    </div>

    <div class="select-wrapper">
      <label style="font-size:15px; font-weight:500;">üî§ Display Font:</label>
      <select id="font-select" onchange="changeFont()">
        <option value="">Loading fonts...</option>
      </select>
    </div>


    <div id="slide-info" style="font-size:14px; margin-bottom:12px; color:#a0a0a0; font-weight:500; display:flex; align-items:center; gap:12px;">
      <span id="slide-counter"></span>
      <div id="slide-dots" style="display:flex; gap:6px; flex-wrap:wrap;"></div>
    </div>

    <div id="slide-thumbnails" class="slide-thumbnails"></div>

    <script>
      const { ipcRenderer } = require('electron');
      let currentSlides = [];
      let currentIndex = 0;
      let currentSongName = '';
      let projectorOpen = false;
      let projectorHidden = false;
      let isServiceSlide = false; // Track if current slide is a service slide
      let isBibleVerse = false; // Track if current slide is a Bible verse

      // Load background images for all selectors
      async function loadBackgrounds() {
        const backgrounds = await ipcRenderer.invoke('get-backgrounds');
        
        // Populate hymnal background selector
        const hymnalSelect = document.getElementById('background-select');
        backgrounds.forEach(bg => {
          const option = document.createElement('option');
          option.value = bg;
          option.textContent = bg;
          hymnalSelect.appendChild(option);
        });
        
        // Populate service background selector
        const serviceSelect = document.getElementById('service-background-select');
        backgrounds.forEach(bg => {
          const option = document.createElement('option');
          option.value = bg;
          option.textContent = bg;
          serviceSelect.appendChild(option);
        });
        
        // Populate Bible verse background selector
        const bibleSelect = document.getElementById('bible-background-select');
        backgrounds.forEach(bg => {
          const option = document.createElement('option');
          option.value = bg;
          option.textContent = bg;
          bibleSelect.appendChild(option);
        });
        
        // Restore saved background selections from localStorage
        const savedHymnalBg = localStorage.getItem('hymnal-background');
        const savedServiceBg = localStorage.getItem('service-background');
        const savedBibleBg = localStorage.getItem('bible-background');
        
        if (savedHymnalBg) {
          hymnalSelect.value = savedHymnalBg;
        }
        if (savedServiceBg) {
          serviceSelect.value = savedServiceBg;
        }
        if (savedBibleBg) {
          bibleSelect.value = savedBibleBg;
        }
      }

      // Load system fonts
      async function loadFonts() {
        const fonts = await ipcRenderer.invoke('get-system-fonts');
        const fontSelect = document.getElementById('font-select');
        
        // Clear loading option
        fontSelect.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = 'Arial';
        defaultOption.textContent = 'Arial (Default)';
        fontSelect.appendChild(defaultOption);
        
        // Populate font selector
        fonts.forEach(font => {
          if (font !== 'Arial') { // Skip Arial since we already added it as default
            const option = document.createElement('option');
            option.value = font;
            option.textContent = font;
            // Apply the font to the option itself for preview
            option.style.fontFamily = font;
            fontSelect.appendChild(option);
          }
        });
        
        // Restore saved font selection from localStorage
        const savedFont = localStorage.getItem('display-font');
        if (savedFont) {
          fontSelect.value = savedFont;
          // Apply saved font immediately
          ipcRenderer.send('set-font', savedFont);
        } else {
          // Set default font
          ipcRenderer.send('set-font', 'Arial');
        }
      }

      // Change font
      async function changeFont() {
        const select = document.getElementById('font-select');
        const fontFamily = select.value;
        
        console.log('=== FONT CHANGE ===');
        console.log('Selected font:', fontFamily);
        
        // Save selection to localStorage
        localStorage.setItem('display-font', fontFamily);
        console.log('Saved to localStorage');
        
        // Send to projector window
        ipcRenderer.send('set-font', fontFamily);
        console.log('Sent set-font to main process');
        
        // Wait a moment for the font to be applied
        await new Promise(resolve => setTimeout(resolve, 200));
        
        // If there's a current slide, re-show it with new font
        if (currentSlides.length > 0) {
          console.log('Re-displaying current slide with new font');
          showSlide();
        }
        
        // Visual feedback
        select.style.backgroundColor = '#2ecc71';
        setTimeout(() => {
          select.style.backgroundColor = '#2a2a3e';
        }, 300);
        
        console.log('===================');
      }

      // Change hymnal background
      function changeBackground() {
        const select = document.getElementById('background-select');
        const filename = select.value;
        
        // Save selection to localStorage
        localStorage.setItem('hymnal-background', filename);
        
        // Only apply if currently showing a hymnal slide
        if (!isServiceSlide && !isBibleVerse && currentSlides.length > 0) {
          ipcRenderer.send('set-background', filename);
        }
        // Otherwise just store the selection for later use
      }

      // Change service background
      function changeServiceBackground() {
        const select = document.getElementById('service-background-select');
        const filename = select.value;
        
        // Save selection to localStorage
        localStorage.setItem('service-background', filename);
        
        // Only apply if currently showing a service slide
        if (isServiceSlide && currentSlides.length > 0) {
          ipcRenderer.send('set-background', filename);
        }
        // Otherwise just store the selection for later use
      }

      // Change Bible verse background
      function changeBibleBackground() {
        const select = document.getElementById('bible-background-select');
        const filename = select.value;
        
        // Save selection to localStorage
        localStorage.setItem('bible-background', filename);
        
        // Only apply if currently showing a Bible verse
        if (isBibleVerse && currentSlides.length > 0) {
          ipcRenderer.send('set-background', filename);
        }
        // Otherwise just store the selection for later use
      }

      // Listen for song loaded from list window
      ipcRenderer.on('song-loaded', (_, data) => {
        console.log('Song loaded:', data.name, 'Slides:', data.slides.length);
        currentSlides = data.slides;
        currentSongName = data.name;
        currentIndex = 0;
        
        // Detect if this is a service slide or Bible verse
        isServiceSlide = data.name.startsWith('Service:') || data.name.startsWith('Title:');
        isBibleVerse = data.name.startsWith('Bible:');
        
        
        if (currentSlides.length > 0) {
          // Apply appropriate background when song loads
          if (isBibleVerse) {
            const select = document.getElementById('bible-background-select');
            const filename = select.value;
            if (filename) {
              ipcRenderer.send('set-background', filename);
            } else {
              // No Bible background selected, clear background
              ipcRenderer.send('set-background', '');
            }
          } else if (isServiceSlide) {
            const select = document.getElementById('service-background-select');
            const filename = select.value;
            if (filename) {
              ipcRenderer.send('set-background', filename);
            } else {
              // No service background selected, clear background
              ipcRenderer.send('set-background', '');
            }
          } else {
            const select = document.getElementById('background-select');
            const filename = select.value;
            if (filename) {
              ipcRenderer.send('set-background', filename);
            } else {
              // No hymnal background selected, use first available or clear
              ipcRenderer.send('set-background', '');
            }
          }
          createSlideDots();
          showSlide();
        }
      });

      function createSlideDots() {
        const dotsContainer = document.getElementById('slide-dots');
        dotsContainer.innerHTML = '';
        
        for (let i = 0; i < currentSlides.length; i++) {
          const dot = document.createElement('div');
          dot.className = 'slide-dot';
          dot.textContent = i + 1;
          dot.title = `Jump to slide ${i + 1}`;
          dot.onclick = () => jumpToSlide(i);
          dotsContainer.appendChild(dot);
        }
        
        // Create slide thumbnails
        createSlideThumbnails();
      }

      function createSlideThumbnails() {
        const thumbnailsContainer = document.getElementById('slide-thumbnails');
        thumbnailsContainer.innerHTML = '';
        
        for (let i = 0; i < currentSlides.length; i++) {
          const thumbnail = document.createElement('div');
          thumbnail.className = 'slide-thumbnail';
          if (i === currentIndex) {
            thumbnail.classList.add('active');
          }
          
          const number = document.createElement('div');
          number.className = 'slide-thumbnail-number';
          number.textContent = i + 1;
          
          const content = document.createElement('div');
          content.className = 'slide-thumbnail-content';
          
          const slideData = currentSlides[i];
          
          // Check if this is an image slide (presentation)
          if (typeof slideData === 'object' && slideData.type === 'image') {
            // Display image thumbnail
            const img = document.createElement('img');
            img.src = `file:///${slideData.path.replace(/\\/g, '/')}`;
            img.style.cssText = 'max-width: 100%; max-height: 120px; object-fit: contain; border-radius: 4px;';
            content.appendChild(img);
          } else {
            // Display text slide
            const slideText = typeof slideData === 'object' ? slideData.content : slideData;
            content.textContent = slideText;
          }
          
          thumbnail.appendChild(number);
          thumbnail.appendChild(content);
          thumbnail.onclick = () => jumpToSlide(i);
          
          thumbnailsContainer.appendChild(thumbnail);
        }
      }

      function jumpToSlide(index) {
        if (index >= 0 && index < currentSlides.length) {
          currentIndex = index;
          showSlide();
        }
      }

      function updateSlideDots() {
        const dots = document.querySelectorAll('.slide-dot');
        dots.forEach((dot, index) => {
          if (index === currentIndex) {
            dot.classList.add('active');
          } else {
            dot.classList.remove('active');
          }
        });
        
        // Also update thumbnails
        const thumbnails = document.querySelectorAll('.slide-thumbnail');
        thumbnails.forEach((thumbnail, index) => {
          if (index === currentIndex) {
            thumbnail.classList.add('active');
            // Scroll to active thumbnail
            thumbnail.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } else {
            thumbnail.classList.remove('active');
          }
        });
      }

      function showSlide() {
        if (currentSlides.length === 0) {
          console.log('No slides to show');
          return;
        }
        const slideData = currentSlides[currentIndex];
        
        console.log('Showing slide', currentIndex + 1, 'of', currentSlides.length);
        
        // Update UI
        document.getElementById('song-title').textContent = currentSongName;
        document.getElementById('slide-counter').textContent = `Slide ${currentIndex + 1} / ${currentSlides.length}`;
        
        // Update slide dots and thumbnails
        updateSlideDots();
        
        // Check if slide is text or image
        if (typeof slideData === 'object' && slideData.type === 'image') {
          // Send image path to projector
          const payload = { 
            type: 'image', 
            path: slideData.path,
            slideIndex: currentIndex, 
            totalSlides: currentSlides.length 
          };
          console.log('Control sending image to projector:', payload);
          ipcRenderer.send('show-slide', payload);
        } else {
          // Send text slide
          const text = typeof slideData === 'object' ? slideData.content : slideData;
          const payload = { 
            type: 'text',
            text, 
            slideIndex: currentIndex, 
            totalSlides: currentSlides.length 
          };
          console.log('Control sending text to projector:', text.substring(0, 50));
          ipcRenderer.send('show-slide', payload);
        }
      }

      function nextSlide() {
        console.log('Next clicked, current:', currentIndex, 'total:', currentSlides.length);
        if (currentIndex < currentSlides.length - 1) {
          currentIndex++;
          showSlide();
        } else {
          console.log('Already at last slide');
        }
      }

      function prevSlide() {
        console.log('Previous clicked, current:', currentIndex);
        if (currentIndex > 0) {
          currentIndex--;
          showSlide();
        } else {
          console.log('Already at first slide');
        }
      }

      function clearScreen() {
        console.log('clearScreen called');
        const preview = document.getElementById('preview');
        preview.innerHTML = `
          <div id="preview-overlay" style="position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); border-radius:10px;"></div>
          <div style="color:#666; position:relative; z-index:1;">Screen Cleared</div>
        `;
        currentSlideIndex = -1; // Reset slide index
        ipcRenderer.send('show-slide', '');
        console.log('Clear message sent to projector');
      }

      function toggleProjector() {
        console.log('Toggle projector - current state:', projectorOpen);
        if (projectorOpen) {
          console.log('Closing projector...');
          ipcRenderer.send('close-projector');
        } else {
          console.log('Opening projector...');
          ipcRenderer.send('open-projector');
        }
      }

      function updateProjectorButton(isOpen) {
        console.log('Updating projector button state to:', isOpen);
        projectorOpen = isOpen;
        const button = document.getElementById('projector-toggle');
        const hideButton = document.getElementById('projector-hide');
        
        if (isOpen) {
          button.innerHTML = '‚ùå Close Projector <span class="shortcut">Alt+X</span>';
          button.className = 'btn btn-warning';
          hideButton.style.display = 'inline-flex';
          updateHideButton(false); // Reset hide state when opening
        } else {
          button.innerHTML = 'üì∫ Open Projector <span class="shortcut">Alt+X</span>';
          button.className = 'btn btn-success';
          hideButton.style.display = 'none';
          projectorHidden = false;
        }
      }

      function toggleHideProjector() {
        if (projectorHidden) {
          ipcRenderer.send('show-projector');
        } else {
          ipcRenderer.send('hide-projector');
        }
      }

      function updateHideButton(isHidden) {
        projectorHidden = isHidden;
        const hideButton = document.getElementById('projector-hide');
        if (isHidden) {
          hideButton.innerHTML = 'üëÅÔ∏è Show Projector <span class="shortcut">Alt+U</span>';
          hideButton.className = 'btn btn-secondary';
        } else {
          hideButton.innerHTML = 'üôà Hide Projector <span class="shortcut">Alt+U</span>';
          hideButton.className = 'btn btn-hide';
        }
      }

      // Font size control functions
      function increaseFontSize() {
        ipcRenderer.send('adjust-font-size', 'increase');
      }

      function decreaseFontSize() {
        ipcRenderer.send('adjust-font-size', 'decrease');
      }

      function resetFontSize() {
        ipcRenderer.send('adjust-font-size', 'reset');
      }

      // Keyboard shortcuts for font size control
      document.addEventListener('keydown', (event) => {
        // Arrow Up = Increase font size
        if (event.key === 'ArrowUp') {
          event.preventDefault();
          increaseFontSize();
        }
        // Arrow Down = Decrease font size
        else if (event.key === 'ArrowDown') {
          event.preventDefault();
          decreaseFontSize();
        }
        // Ctrl+0 = Reset font size
        else if (event.ctrlKey && event.key === '0') {
          event.preventDefault();
          resetFontSize();
        }
      });

      // Image zoom control functions
      function zoomInImage() {
        ipcRenderer.send('adjust-image-zoom', 'in');
      }

      function zoomOutImage() {
        ipcRenderer.send('adjust-image-zoom', 'out');
      }

      function resetImageZoom() {
        ipcRenderer.send('adjust-image-zoom', 'reset');
      }

      // Listen for projector state changes
      ipcRenderer.on('projector-state', (event, isOpen) => {
        updateProjectorButton(isOpen);
      });

      ipcRenderer.on('projector-visibility', (event, isHidden) => {
        updateHideButton(isHidden);
      });

      // Listen for image display state
      ipcRenderer.on('image-displayed', (event, isImage) => {
        const zoomControls = document.getElementById('image-zoom-controls');
        if (zoomControls) {
          zoomControls.style.display = isImage ? 'flex' : 'none';
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ') {
          e.preventDefault();
          nextSlide();
        }
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevSlide();
        }
        if (e.altKey && e.key.toLowerCase() === 'x') {
          e.preventDefault();
          toggleProjector();
        }
        if (e.altKey && e.key.toLowerCase() === 'u') {
          e.preventDefault();
          toggleHideProjector();
        }
      });

      // Visual Editor Variables
      let editorElements = [];
      let selectedElement = null;
      let isDragging = false;
      let dragOffsetX = 0;
      let dragOffsetY = 0;
      let elementIdCounter = 0;
      let currentEditingService = null;
      let editingVisualSlideIndex = -1;
      let editingVisualSlide = null;

      // Listen for open visual editor message from list window
      ipcRenderer.on('open-visual-editor', (_, data) => {
        console.log('Received open-visual-editor message:', data);
        currentEditingService = data.service;
        
        // Check if we're editing an existing slide (any type)
        if (data.editingSlide) {
          console.log('Editing existing slide:', data.editingSlide);
          editingVisualSlideIndex = data.editingIndex;
          editingVisualSlide = data.editingSlide;
        } else {
          editingVisualSlideIndex = -1;
          editingVisualSlide = null;
        }
        
        openVisualEditor();
      });

      // Open Visual Editor
      function openVisualEditor() {
        document.getElementById('visualEditorModal').style.display = 'block';
        
        // Clear previous content
        editorElements = [];
        selectedElement = null;
        document.getElementById('editorCanvas').innerHTML = '';
        elementIdCounter = 0;
        
        // If editing existing slide (any type), load its content
        if (editingVisualSlide) {
          console.log('Loading existing slide elements:', editingVisualSlide);
          loadExistingVisualSlide();
        }
      }

      // Close Visual Editor
      function closeVisualEditor() {
        document.getElementById('visualEditorModal').style.display = 'none';
        editorElements = [];
        selectedElement = null;
        document.getElementById('editorCanvas').innerHTML = '';
        editingVisualSlideIndex = -1;
        editingVisualSlide = null;
      }

      // Add Text Element
      function addTextElement() {
        const canvas = document.getElementById('editorCanvas');
        const element = document.createElement('div');
        element.className = 'text-element';
        element.id = 'element-' + (elementIdCounter++);
        element.textContent = 'Click to edit';
        element.style.left = '50px';
        element.style.top = '50px';
        element.style.fontSize = '48px';
        element.style.color = '#ffffff';
        element.style.textAlign = 'center';
        element.contentEditable = true; // Make directly editable
        element.setAttribute('data-placeholder', 'Click to edit');
        
        // Add event listeners
        element.addEventListener('mousedown', startDrag);
        element.addEventListener('click', selectElement);
        element.addEventListener('input', updateElementText);
        element.addEventListener('blur', finishEditing);
        
        canvas.appendChild(element);
        editorElements.push({
          id: element.id,
          text: element.textContent,
          x: 50,
          y: 50,
          fontSize: 48,
          color: '#ffffff',
          align: 'center'
        });
        
        selectElement({ target: element });
        element.focus(); // Focus for immediate editing
      }

      // Select Element
      function selectElement(e) {
        if (selectedElement) {
          selectedElement.classList.remove('selected');
        }
        selectedElement = e.target.closest('.text-element');
        if (selectedElement) {
          selectedElement.classList.add('selected');
          
          // Update toolbar with element properties
          document.getElementById('fontSize').value = parseInt(selectedElement.style.fontSize);
          document.getElementById('textColor').value = rgbToHex(selectedElement.style.color);
        }
      }

      // Start Drag
      function startDrag(e) {
        if (e.target.classList.contains('text-element')) {
          // If not holding Shift, allow text edit/caret and don't drag
          if (!e.shiftKey) {
            // focus the element for editing
            e.target.focus();
            return; // do not start dragging
          }

          isDragging = true;
          selectedElement = e.target;
          selectElement(e);
          
          const rect = selectedElement.getBoundingClientRect();
          const canvasRect = document.getElementById('editorCanvas').getBoundingClientRect();
          dragOffsetX = e.clientX - rect.left + canvasRect.left;
          dragOffsetY = e.clientY - rect.top + canvasRect.top;
          
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
          
          e.preventDefault();
        }
      }

      // Drag
      function drag(e) {
        if (isDragging && selectedElement) {
          const canvasRect = document.getElementById('editorCanvas').getBoundingClientRect();
          let x = e.clientX - canvasRect.left - dragOffsetX;
          let y = e.clientY - canvasRect.top - dragOffsetY;
          
          // Keep within bounds
          x = Math.max(0, Math.min(x, canvasRect.width - selectedElement.offsetWidth));
          y = Math.max(0, Math.min(y, canvasRect.height - selectedElement.offsetHeight));
          
          selectedElement.style.left = x + 'px';
          selectedElement.style.top = y + 'px';
          
          // Update in elements array
          const elemData = editorElements.find(el => el.id === selectedElement.id);
          if (elemData) {
            elemData.x = x;
            elemData.y = y;
          }
        }
      }

      // Stop Drag
      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
      }

      // Update element text when content changes
      function updateElementText(e) {
        const element = e.target;
        const elemData = editorElements.find(el => el.id === element.id);
        if (elemData) {
          elemData.text = element.textContent;
        }
      }

      // Finish editing when element loses focus
      function finishEditing(e) {
        const element = e.target;
        const elemData = editorElements.find(el => el.id === element.id);
        if (elemData) {
          elemData.text = element.textContent;
        }
      }

      // Update Selected Element
      function updateSelectedElement() {
        if (selectedElement) {
          const fontSize = document.getElementById('fontSize').value;
          const textColor = document.getElementById('textColor').value;
          
          selectedElement.style.fontSize = fontSize + 'px';
          selectedElement.style.color = textColor;
          
          // Update in elements array
          const elemData = editorElements.find(el => el.id === selectedElement.id);
          if (elemData) {
            elemData.fontSize = parseInt(fontSize);
            elemData.color = textColor;
          }
        }
      }

      // Align Text
      function alignText(alignment) {
        if (selectedElement) {
          selectedElement.style.textAlign = alignment;
          const elemData = editorElements.find(el => el.id === selectedElement.id);
          if (elemData) {
            elemData.align = alignment;
          }
          console.log('Aligned text to:', alignment);
        }
      }

      // Delete Selected Element
      function deleteSelectedElement() {
        if (selectedElement) {
          const index = editorElements.findIndex(el => el.id === selectedElement.id);
          if (index > -1) {
            editorElements.splice(index, 1);
          }
          selectedElement.remove();
          selectedElement = null;
        }
      }

      // RGB to Hex converter
      function rgbToHex(rgb) {
        if (rgb.startsWith('#')) return rgb;
        const result = rgb.match(/\d+/g);
        if (!result) return '#ffffff';
        return '#' + result.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
      }

      // Save Service Slide
      function saveServiceSlide() {
        if (editorElements.length === 0) {
          console.log('No elements to save');
          return;
        }
        
        // Convert elements to service slide format
        const slideData = {
          type: 'visual',
          service: currentEditingService,
          elements: editorElements.map(el => ({
            text: el.text,
            x: el.x,
            y: el.y,
            fontSize: el.fontSize,
            color: el.color,
            align: el.align
          }))
        };
        
        // If editing existing slide, include the editing index
        if (editingVisualSlideIndex >= 0) {
          slideData.editingIndex = editingVisualSlideIndex;
          console.log('Updating existing slide at index:', editingVisualSlideIndex);
        } else {
          console.log('Creating new visual slide');
        }
        
        console.log('Saving service slide:', slideData);
        
        // Send to main process to forward to list window
        ipcRenderer.send('save-visual-slide', slideData);
        
        // Clear and close editor
        editorElements = [];
        selectedElement = null;
        document.getElementById('editorCanvas').innerHTML = '';
        document.getElementById('visualEditorModal').style.display = 'none';
        editingVisualSlideIndex = -1;
        editingVisualSlide = null;
      }

      // Load Existing Slide (handles all slide types)
      function loadExistingVisualSlide() {
        if (!editingVisualSlide) {
          console.log('No slide data to load');
          return;
        }
        
        const canvas = document.getElementById('editorCanvas');
        
        if (editingVisualSlide.type === 'visual' && editingVisualSlide.elements) {
          // Load existing visual slide elements
          editingVisualSlide.elements.forEach((elementData, index) => {
            const element = document.createElement('div');
            element.className = 'text-element';
            element.id = 'element-' + (elementIdCounter++);
            element.textContent = elementData.text;
            element.style.left = elementData.x + 'px';
            element.style.top = elementData.y + 'px';
            element.style.fontSize = elementData.fontSize + 'px';
            element.style.color = elementData.color;
            element.style.textAlign = elementData.align;
            element.contentEditable = true; // Make directly editable
            
            // Add event listeners
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('click', selectElement);
            element.addEventListener('input', updateElementText);
            element.addEventListener('blur', finishEditing);
            
            canvas.appendChild(element);
            
            // Add to editor elements array
            editorElements.push({
              id: element.id,
              text: elementData.text,
              x: elementData.x,
              y: elementData.y,
              fontSize: elementData.fontSize,
              color: elementData.color,
              align: elementData.align
            });
          });
          console.log('Loaded', editorElements.length, 'visual elements');
        } else {
          // Convert other slide types to visual elements
          let elements = [];
          
          if (editingVisualSlide.type === 'title') {
            // Convert title slide to visual elements
            if (editingVisualSlide.titleText) {
              elements.push({
                text: editingVisualSlide.titleText,
                x: 100,
                y: 200,
                fontSize: 72,
                color: '#ffffff',
                align: 'center'
              });
            }
            if (editingVisualSlide.titleSubtitle) {
              elements.push({
                text: editingVisualSlide.titleSubtitle,
                x: 100,
                y: 300,
                fontSize: 48,
                color: '#a8e063',
                align: 'center'
              });
            }
          } else if (editingVisualSlide.type === 'bible') {
            // Convert bible verse to visual elements
            if (editingVisualSlide.verseText) {
              elements.push({
                text: `"${editingVisualSlide.verseText}"`,
                x: 100,
                y: 200,
                fontSize: 48,
                color: '#ffffff',
                align: 'center'
              });
            }
            if (editingVisualSlide.reference) {
              elements.push({
                text: editingVisualSlide.reference,
                x: 100,
                y: 400,
                fontSize: 36,
                color: '#a8e063',
                align: 'center'
              });
            }
          } else {
            // Convert normal slide to visual elements
            if (editingVisualSlide.position) {
              elements.push({
                text: editingVisualSlide.position,
                x: 100,
                y: 150,
                fontSize: 60,
                color: '#ffffff',
                align: 'center'
              });
            }
            if (editingVisualSlide.title) {
              elements.push({
                text: editingVisualSlide.title,
                x: 100,
                y: 250,
                fontSize: 48,
                color: '#a8e063',
                align: 'center'
              });
            }
            if (editingVisualSlide.name) {
              elements.push({
                text: editingVisualSlide.name,
                x: 100,
                y: 350,
                fontSize: 42,
                color: '#ffffff',
                align: 'center'
              });
            }
          }
          
          // Create visual elements from converted data
          elements.forEach((elementData, index) => {
            const element = document.createElement('div');
            element.className = 'text-element';
            element.id = 'element-' + (elementIdCounter++);
            element.textContent = elementData.text;
            element.style.left = elementData.x + 'px';
            element.style.top = elementData.y + 'px';
            element.style.fontSize = elementData.fontSize + 'px';
            element.style.color = elementData.color;
            element.style.textAlign = elementData.align;
            element.contentEditable = true; // Make directly editable
            
            // Add event listeners
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('click', selectElement);
            element.addEventListener('input', updateElementText);
            element.addEventListener('blur', finishEditing);
            
            canvas.appendChild(element);
            
            // Add to editor elements array
            editorElements.push({
              id: element.id,
              text: elementData.text,
              x: elementData.x,
              y: elementData.y,
              fontSize: elementData.fontSize,
              color: elementData.color,
              align: elementData.align
            });
          });
          
          console.log('Converted', editingVisualSlide.type, 'slide to', editorElements.length, 'visual elements');
        }
      }


      // Keyboard event handling for visual editor
      document.addEventListener('keydown', (e) => {
        // Only handle keys when visual editor is open
        const editorModal = document.getElementById('visualEditorModal');
        if (editorModal && editorModal.style.display === 'block') {
          if ((e.key === 'Delete' || e.key === 'Backspace')) {
            // If caret is inside an editable element, let browser handle Backspace/Delete
            const active = document.activeElement;
            if (active && active.classList && active.classList.contains('text-element')) {
              return; // allow native text deletion
            }
            e.preventDefault();
            deleteSelectedElement();
          }
        }
      });

      // Initialize
      loadBackgrounds();
      loadFonts();
    </script>
    
    <div class="copyright-footer">¬© 2025 Songnam Saraphai. All rights reserved.</div>

    <!-- Visual Editor Modal -->
    <div id="visualEditorModal" class="editor-modal">
      <div class="editor-content">
        <h2 style="margin-top:0; color:#a8e063;">üé® Visual Service Slide Editor</h2>
        
        <div class="editor-toolbar">
          <div class="toolbar-group">
            <button class="toolbar-btn" onclick="addTextElement()">‚ûï Add Text</button>
          </div>
          
          <div class="toolbar-group">
            <span class="toolbar-label">Font Size:</span>
            <input type="number" id="fontSize" class="toolbar-input" value="48" min="12" max="200" onchange="updateSelectedElement()">
          </div>
          
          <div class="toolbar-group">
            <span class="toolbar-label">Color:</span>
            <input type="color" id="textColor" class="toolbar-input" value="#ffffff" onchange="updateSelectedElement()">
          </div>
          
          <div class="toolbar-group">
            <span class="toolbar-label">Align:</span>
            <button class="toolbar-btn" onclick="alignText('left')">‚¨Ö</button>
            <button class="toolbar-btn" onclick="alignText('center')">‚Üî</button>
            <button class="toolbar-btn" onclick="alignText('right')">‚û°</button>
          </div>
          
          <div class="toolbar-group">
            <button class="toolbar-btn" onclick="saveServiceSlide()">üíæ Save</button>
            <button class="toolbar-btn" onclick="closeVisualEditor()">‚ùå Close</button>
          </div>
        </div>

        <div id="editorCanvas" class="editor-canvas"></div>

        <div style="margin-top:10px; color:#aaa; font-size:12px;">
          üí° <strong>Tips:</strong> Click "Add Text" to create new text elements. Click and drag to position them. Click text to edit directly. Use Delete key to remove selected elements.
        </div>
      </div>
    </div>
  </body>
</html>
